<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DM Audio Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="audioApp.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            position:fixed;
            bottom:0;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #e2e8f0;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid #475569;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        input[type=range]:active::-webkit-slider-thumb {
            background: #818cf8;
            transform: scale(1.1);
        }
        .glass-nav button {
            margin:1em;
        }
    </style>
</head>
<body class="text-slate-200 h-screen overflow-hidden selection:bg-indigo-500 selection:text-white">

<div x-data="audioApp()" x-init="init()" class="h-full flex flex-col max-w-lg mx-auto bg-slate-900 shadow-2xl relative">

    <!-- TOP HEADER -->
    <header class="px-5 pt-6 pb-4 flex justify-between items-center bg-gradient-to-b from-slate-900 to-slate-900/95 z-20">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-layer-group text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight text-slate-100">LoopStack</h1>
                <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Session Manager</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
             <button @click="stopAll()" class="px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-bold hover:bg-red-500 hover:text-white transition flex items-center gap-2">
                <i class="fa-solid fa-stop"></i> Stop All
            </button>
        </div>
    </header>

    <!-- MAIN SCROLL AREA -->
    <main class="flex-1 overflow-y-auto no-scrollbar pb-24 scroll-smooth px-5">
        
        <!-- DASHBOARD (THE STACK) -->
        <div x-show="activeTab === 'dashboard'" x-transition.opacity.duration.300ms class="space-y-4">
            
            <div x-show="activeStack.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-500 gap-3 border-2 border-dashed border-slate-800 rounded-2xl bg-slate-800/20">
                <i class="fa-solid fa-music text-3xl opacity-50"></i>
                <p class="text-sm">No loops active</p>
                <button @click="activeTab = 'library'" class="text-indigo-400 text-xs font-bold hover:underline">Go to Library</button>
            </div>

            <!-- Loop Items -->
            <template x-for="(track, index) in activeStack" :key="track.id">
                <div class="glass-panel p-4 rounded-xl flex flex-col gap-3 relative group transition-all duration-300 hover:bg-slate-800/50 hover:border-slate-600">
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-300 flex-shrink-0">
                                <i class="fa-solid" :class="track.isPlaying ? 'fa-volume-high animate-pulse' : 'fa-volume-off'"></i>
                            </div>
                            <h3 class="font-bold text-slate-200 truncate" x-text="track.title"></h3>
                        </div>
                        
                        <div class="flex items-center gap-2 pl-2">
                            <button @click="togglePlay(track)" 
                                class="w-10 h-10 rounded-full flex items-center justify-center transition shadow-lg"
                                :class="track.isPlaying ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'">
                                <i class="fa-solid" :class="track.isPlaying ? 'fa-pause' : 'fa-play pl-0.5'"></i>
                            </button>
                            
                            <button @click="removeFromStack(index)" class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 text-slate-400 flex items-center justify-center hover:text-red-400 hover:border-red-500/50 transition">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 pt-1">
                        <i class="fa-solid fa-volume-low text-xs text-slate-500"></i>
                        <input type="range" min="0" max="100" x-model="track.volume" @input="setTrackVolume(track)" class="accent-indigo-500">
                        <i class="fa-solid fa-volume-high text-xs text-slate-500"></i>
                    </div>

                    <div class="absolute inset-0 bg-indigo-500/5 rounded-xl -z-10 transition-opacity duration-500" :class="track.isPlaying ? 'opacity-100' : 'opacity-0'"></div>
                </div>
            </template>
        </div>

        <!-- LIBRARY TAB -->
        <div x-show="activeTab === 'library'" style="display: none;" class="space-y-4">
            
            <!-- Search -->
            <div class="relative group mb-2">
                <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-3.5 text-slate-500 transition"></i>
                <input type="text" placeholder="Find loops..." 
                    class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-slate-200 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition placeholder-slate-500">
            </div>

            <!-- Tag Filter Pills -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mask-linear">
                <template x-for="tag in filterTags" :key="tag.name">
                    <button 
                        @click="selectedTag = tag.name"
                        class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap border transition flex items-center gap-2 active:scale-95"
                        :class="selectedTag === tag.name 
                            ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-900/50' 
                            : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200'">
                        <span x-text="tag.emoji"></span>
                        <span x-text="tag.name"></span>
                    </button>
                </template>
            </div>

            <!-- Filtered Loops List -->
            <section>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest" x-text="selectedTag + ' Loops'"></h3>
                    <span class="text-[10px] text-slate-600 bg-slate-800 px-2 py-0.5 rounded-full" x-text="filteredTracks.length"></span>
                </div>

                <div x-show="loading" class="py-8 text-center text-slate-500 text-sm">Loading library...</div>
                <div x-show="!loading" class="bg-slate-800/30 rounded-xl divide-y divide-slate-800/50 border border-slate-700/30">
                    <template x-for="track in filteredTracks" :key="track.id">
                        <div>
                        <div @click="confirmPlay(track)" class="p-3.5 flex items-center justify-between hover:bg-white/5 transition cursor-pointer group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-slate-500 group-hover:bg-indigo-600 group-hover:text-white transition">
                                    <i class="fa-solid fa-music text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-300 group-hover:text-white transition" x-text="track.title"></p>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <template x-for="tag in getTrackTags(track)" :key="tag">
                                            <span class="text-[10px] text-slate-500 bg-slate-800 px-1.5 py-0.5 rounded" x-text="tag"></span>
                                        </template>
                                        <span class="text-[10px] text-slate-600">â€¢</span>
                                        <span class="text-[10px] text-slate-600" x-text="track.duration"></span>
                                    </div>
                                </div>
                            </div>
                                <div class="flex items-center gap-1" @click.stop>
                                    <button type="button" @click="editingTrackId = editingTrackId === track.id ? null : track.id" class="w-8 h-8 rounded-full border border-slate-700 flex items-center justify-center text-slate-400 hover:border-indigo-500/50 hover:text-indigo-400 transition" :class="editingTrackId === track.id && 'border-indigo-500 text-indigo-400'">
                                        <i class="fa-solid fa-tag text-xs"></i>
                                    </button>
                                    <button type="button" @click="deleteTrackFromLibrary(track)" class="w-8 h-8 rounded-full border border-slate-700 flex items-center justify-center text-slate-400 hover:border-red-500/50 hover:text-red-400 transition">
                                        <i class="fa-solid fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div x-show="editingTrackId === track.id" class="px-3.5 pb-3 pt-0 border-t border-slate-800/50" @click.stop>
                                <div class="flex flex-wrap gap-2 pt-2">
                                    <template x-for="tag in filterTags" :key="tag.name">
                                        <button type="button"
                                            @click="toggleTrackTag(track, tag.name)"
                                            class="px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition"
                                            :class="getTrackTags(track).includes(tag.name)
                                                ? 'bg-indigo-600 border-indigo-500 text-white'
                                                : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200'">
                                            <span x-text="tag.emoji"></span>
                                            <span x-text="tag.name"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Empty State for Filter -->
                    <div x-show="filteredTracks.length === 0" class="p-8 text-center text-slate-500 text-sm">
                        No loops found for this filter.
                    </div>
                </div>
            </section>
        </div>

        <!-- UPLOAD TAB -->
        <div x-show="activeTab === 'upload'" style="display: none;" class="space-y-6 pt-4">
            <input type="file" @change="setUploadAudioFile($event.target.files[0]); $event.target.value = ''" class="hidden" id="upload-audio-input">
            <label for="upload-audio-input" class="block border-2 border-dashed border-slate-700 bg-slate-800/20 rounded-2xl h-40 flex flex-col items-center justify-center text-center gap-3 hover:border-indigo-500/50 hover:bg-slate-800/40 transition cursor-pointer">
                <i class="fa-solid fa-cloud-arrow-up text-indigo-400 text-2xl"></i>
                <p class="text-sm text-slate-300" x-text="uploadAudioFile ? uploadAudioFile.name : 'Upload Loop File'"></p>
                <p x-show="uploadAudioFile" class="text-xs text-slate-500" x-text="uploadAudioFile ? (uploadAudioFile.size / 1024).toFixed(1) + ' KB' : ''"></p>
            </label>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Details</label>
                <input type="text" x-model="uploadTrackName" placeholder="Loop Name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-indigo-500 outline-none mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-3">Tag</label>
                <div class="flex flex-wrap gap-2">
                    <template x-for="tag in filterTags" :key="tag.name">
                        <button type="button"
                            @click="toggleUploadTag(tag.name)"
                            class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap border transition flex items-center gap-2 active:scale-95"
                            :class="uploadTrackTags.includes(tag.name)
                                ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-900/50'
                                : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200'">
                            <span x-text="tag.emoji"></span>
                            <span x-text="tag.name"></span>
                        </button>
                    </template>
                </div>
            </div>
            <button @click="uploadTrackName && saveTrackToLibrary({ title: uploadTrackName, tags: uploadTrackTags.length ? uploadTrackTags : ['All'], audioData: uploadAudioFile })" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition">Save to Library</button>
        </div>

        <!-- SETTINGS TAB -->
        <div x-show="activeTab === 'settings'" style="display: none;" class="space-y-6 pt-4">
            <input type="file" accept=".json,application/json" x-ref="importFileInput" @change="importData($event.target.files[0]); $event.target.value = ''" class="hidden">
            <div class="glass-panel rounded-xl p-5 space-y-4">
                <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Data</h3>
                <button type="button" @click="exportData()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-200 font-bold rounded-xl transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-export"></i>
                    Export
                </button>
                <button type="button" @click="triggerImportInput()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-200 font-bold rounded-xl transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-import"></i>
                    Import
                </button>
                <button type="button" @click="deleteAllTracks()" class="w-full py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 font-bold rounded-xl transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash"></i>
                    Delete All Tracks
                </button>
            </div>
        </div>
    </main>

    <!-- "ADD TO STACK" MODAL -->
    <div x-show="modalOpen" class="absolute inset-0 z-50 flex sm:items-center justify-center bg-black/80 backdrop-blur-sm"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         style="display: none; align-items: center">
        
        <div class="bg-slate-900 w-full max-w-sm rounded-t-2xl sm:rounded-2xl border border-slate-700 p-6 shadow-2xl transform transition-transform"
             @click.away="modalOpen = false">
            
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-indigo-600/20 text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-layer-group text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-1">Play Selection?</h3>
                <p class="text-sm text-slate-400" x-text="pendingSelection ? `Add '${pendingSelection.title}' to the active loops?` : '...'">...</p>
            </div>

            <div class="space-y-3">
                <button @click="addToStack()" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-900/40 transition active:scale-95">
                    Add to Stack
                </button>
                
                <button @click="replaceStack()" class="w-full py-3.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-200 font-bold rounded-xl transition active:scale-95">
                    Replace All
                </button>
                
                <button @click="modalOpen = false" class="w-full py-2 text-slate-500 text-sm font-medium hover:text-slate-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="glass-nav h-[4.5rem] flex justify-around items-center px-2 pb-1 z-40">
        <button @click="activeTab = 'dashboard'" class="flex flex-col items-center gap-1 w-20 p-2 rounded-xl transition-all duration-300" :class="activeTab === 'dashboard' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'">
            <i class="fa-solid fa-layer-group text-xl mb-0.5"></i>
            <span class="text-[10px] font-bold tracking-wide">Stack</span>
        </button>

        <button @click="activeTab = 'library'" class="flex flex-col items-center gap-1 w-20 p-2 rounded-xl transition-all duration-300" :class="activeTab === 'library' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'">
             <i class="fa-solid fa-list-ul text-xl mb-0.5"></i>
            <span class="text-[10px] font-bold tracking-wide">Library</span>
        </button>

        <button @click="activeTab = 'upload'" class="flex flex-col items-center gap-1 w-20 p-2 rounded-xl transition-all duration-300" :class="activeTab === 'upload' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'">
             <i class="fa-solid fa-cloud-arrow-up text-xl mb-0.5"></i>
            <span class="text-[10px] font-bold tracking-wide">Upload</span>
        </button>

        <button @click="activeTab = 'settings'" class="flex flex-col items-center gap-1 w-20 p-2 rounded-xl transition-all duration-300" :class="activeTab === 'settings' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'">
            <i class="fa-solid fa-gear text-xl mb-0.5"></i>
            <span class="text-[10px] font-bold tracking-wide">Settings</span>
        </button>
    </nav>

</div>
</body>
</html>